---
title: ''
author: ''
date: ''
output: 
  html_document:
    df_print: paged
    keep_md: true
  word_document:
    reference_docx: style.1.docx
---

```{r setup, include = FALSE}

  knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                        fig.width  = 6 * 1.67, fig.height = 6)

  # proj <- rprojroot::find_rstudio_root_file()
  # knitr::opts_knit$set(root.dir = proj)
  # 
  # load(paste0(proj, "/data/data.RData"))
  # 
  # source(paste0(proj, "/scripts/functions.R"))

  load("data/data.RData")

  source("scripts/functions.R")
  
  library(logbin)
  library(MASS)
  library(descr)
  library(tidyverse)
  library(viridis)
  library(flextable)
  library(patchwork)
  library(knitr)
  library(pander)

```


There were `r length(unique(data$identifier))` patients in the trial dataset, recruited from `r length(unique(data$siteid))` sites (**NOTE**: the trial paper says 46 sites). 

Patients were randomized between `r min(data$rand_dt)` and `r max(data$rand_dt)`. 

## Timing of key study points

```{r}

# Timing of different measurements
# Randomization, Iron Pre-op, Post-op, 30 days, 8 weeks, 6 months
# names(data)[c(47, 49, 51, 53:57)]

  tar <- which(names(data) %in% names(select(data, ends_with("_dt"))))
  labs <- label.list[tar]
  levs <- names(data)[tar]

  select(data, identifier, wdraw_or_ltf, ends_with(("_dt"))) %>%
    mutate(identifier = reorder(factor(identifier), rand_dt)) %>%
    gather(type, time, - identifier, - wdraw_or_ltf) %>%
    mutate(type = factor(type, levels = levs, labels = labs)) %>%
  ggplot(aes(y = identifier, x = time, color = type, group = identifier)) +
    geom_line(alpha = 0.3) +
    geom_point() +
    facet_wrap(~wdraw_or_ltf, ncol = 1) +
    scale_color_viridis("", discrete = TRUE) +
    theme(axis.text.y = element_blank(), 
          axis.ticks.y = element_blank(), 
          panel.grid = element_blank(), 
          panel.background = element_rect(fill = "white")) +
    ylab("") +
    xlab("Date of key events")

```

```{r}

# Had iron, surgery - names(data)[c(48, 52)]

  t1 <- with(data, table(trtyn, surgyn, useNA = "always", dnn = c("Treated?", "Surgery?")))

```

```{r}
# Withdraws/LtF - names(data)[c(60:65)]
  
  t2 <- with(data, table(wdraw, ltfu, useNA = "always"))

```

`r table(data$trtyn)["No"]` randomized patients did not receive the treatment under test; while `r table(data$surgyn)["No"]` did not undergo surgery. There were `r table(data$wdraw)["1"]` withdraws, with `r table(data$wdraw[data$surgyn == "No"])["1"]` of them prior to surgery. (**NOTE**: I don't have information on the type of surgery.)

There were `r t2["0", "0"]` patients in the ITT analysis set. 

There were `r table(data$pp)["1"]` patients in the per protocol set. (**NOTE**: The paper lists 388). 

# Paper Table 1 (Baseline characteristics)

```{r}

  mh <- names(select(data, mi:diabetes))
  mh <- mh[order(mh)]

  table.1.var <- data %>%
    select(
      arm = group,
      age, gender, ethnicity, tdl_hb_bl, tdl_hb_bl_cat, asa_grade, 
      mh, 
      chemo, radio, 
      smoking, 
      aspirin, clopidogrel, warfarin, other_med, 
      iron_med, 
      surgyn, tx_surg_time, tx_surg_time_cat
    )
  
  # map(table.1.var, class)

  act <- filter(table.1.var, arm == "Active") %>% select(-arm)
  con <- filter(table.1.var, arm == "Placebo") %>% select(-arm)

  
  data_frame("Variable" = name.1(select(table.1.var, -arm)),
             "Observations" = as.numeric(n.miss(select(table.1.var, -arm))),
             "Total (n = 487)" = summary.2(select(table.1.var, -arm)),
             "Control (n = 243)" = summary.2(con),
             "Active (n = 244)" = summary.2(act)) %>% 
    flextable() %>% autofit()


  rm(act, con)
  
```

This all matches. 

# Paper Figure 2 (hb over time)

```{r}

  levs <- c("tdl_hb_bl", "tdl_hb_preop", "site_hb_8wk", "site_hb_6mo")
  labs <- c("Baseline", "Pre-op", "8 weeks", "6 months")
  labs2 <- c("0", "15", "56", "180")


  fig_2_data <- select(data, group, levs) %>%
    gather(time, hb, -group) %>%
    mutate(
      time = factor(time, levels = levs, labels = labs), 
      time2  = as.numeric(as.character(factor(time, levels = labs, 
                                              labels = labs2)))
    ) %>% group_by(time2, group) %>%
    summarise(
      n = n(), 
      obs = table(is.na(hb))["FALSE"],
      est = mean(hb, na.rm = TRUE),
      se = sd(hb, na.rm = TRUE) / sqrt(n), 
      ul = est + (1.96 * se), 
      ll = est - (1.96 * se), 
    ) 
  
  fig_2_data[map_lgl(fig_2_data, is.numeric)] <- 
    map_df(fig_2_data[map_lgl(fig_2_data, is.numeric)], function(x) round(x, 2))
  
  fig_2_data <- fig_2_data %>%
    mutate(
      full = paste0(est, " (", ll, " to ", ul, ")"), 
      time = factor(time2, levels = labs2, labels = labs)
      ) %>%
    ungroup()
  
```

```{r}

  ggplot(fig_2_data, aes(x = time2, y = est, ymax = ul, ymin = ll, 
                         color = group)) +
    geom_line(position = position_dodge(width = 3)) +
    geom_point(position = position_dodge(width = 3)) +
    geom_errorbar(position = "dodge", width = 3) +
    scale_color_brewer("", palette = "Set1") +
    scale_x_continuous(breaks = as.numeric(labs2), labels = labs) +
    xlab("") +
    ylab("Mean (95% CI) haemoglobin (g/L)")

```

**NOTE**: I don't have the immediately post surgery values (up to day 14)

## Paper Figure 2 table

```{r, eval = knitr::opts_knit$get("rmarkdown.pandoc.to") == "html"}

  flextable(select(fig_2_data, group, obs, full, time)) %>% autofit()

```


```{r, eval = !knitr::opts_knit$get("rmarkdown.pandoc.to") == "html"}

  kable(select(fig_2_data, group, obs, full, time)) 

```

```{r}

  data_itt   <- filter(data, itt   == "Yes")
  data_itt_2 <- filter(data, itt_2 == "Yes")

```


# Table 2 (Co-primary outcomes)

## Co-primary outcomes (30 day BT or death; number of BT), crude result, total sample

```{r}

  # with(data, table(group)) %>% sum()
  # with(data_itt, table(group)) %>% sum()

  # with(data, table(group, primary_30d)) %>% sum()
  # with(data, table(group, BT_30d)) %>% sum()
  # with(data, table(group, death_30d)) %>% sum()

  # filter(data, is.na(primary_30d) & !is.na(death_30d)) %>% View()
  # 7 patients with missing primary but not death at 30 days. They are all 
  # missing BT at 30 days. 

  table.2.var <- data %>%
    select(
      arm = group, primary_30d, BT_30d, death_30d, BT_30d_num_cat, 
      BT_30d_num
    )
  
  act <- filter(table.2.var, arm == "Active") %>% select(-arm)
  con <- filter(table.2.var, arm == "Placebo") %>% select(-arm)

  data_frame("Variable" = name.1(select(table.2.var, -arm)),
             "Observations" = as.numeric(n.miss(select(table.2.var, -arm))),
             "Control (n = 243; 237)" = summary.1(con),
             "Active (n = 244; 237)" = summary.1(act)) %>% 
    flextable() %>% autofit()

  rm(act, con)


```

These numbers are in the overall sample, rather than the sample specifically flagged as the ITT sample. In the overall sample, I have n = 243 and 244 in the placebo and active groups respectively (as noted at the top of this table and the one in the trial paper). However, the sample sizes given within the table indicate 377 in both groups. Presumably, this is the ITT sample. The only place where the table above differs is that 7 extra observations of death at 30 days for people that didn't have BT at 30 days (and this the first primary at 30 days). 

```{r}

  # table(data$itt,   data$group, dnn = c("ITT?", "Arm"))
  # table(data$itt_2, data$group, dnn = c("ITT?", "Arm"))
  # table(data$itt_2, data$itt, dnn = c("ITT_2?", "ITT?"))

```

## Co-primary outcomes (30 day BT or death; number of BT), crude result, ITT sample

Now we define the ITT sample as having a measure for the first primary at 30 days, then everything adds up correctly and matches table 2 in the paper. 

```{r}

  # with(data, table(group))
  # with(data_itt, table(group))

  # with(data, table(group, primary_30d))
  # with(data, table(group, BT_30d))
  # with(data, table(group, death_30d))
  
  table.2.var <- data_itt_2 %>%
    select(
      arm = group, primary_30d, BT_30d, death_30d, BT_30d_num_cat, 
      BT_30d_num
    )
  
  act <- filter(table.2.var, arm == "Active") %>% select(-arm)
  con <- filter(table.2.var, arm == "Placebo") %>% select(-arm)

  data_frame("Variable" = name.1(select(table.2.var, -arm)),
             "Observations" = as.numeric(n.miss(select(table.2.var, -arm))),
             "Control (n = 243; 237)" = summary.1(con),
             "Active (n = 244; 237)" = summary.1(act)) %>% 
    flextable() %>% autofit()

  rm(act, con)


```


## Model-based estimate for the first primary outcome (RR)

```{r}

  pull_ci <- function(model){
    
    library(broom)
    x <- tidy(model) %>%
      mutate(
        ul = round(exp(estimate + (1.96 * std.error)), 2), 
        ll = round(exp(estimate - (1.96 * std.error)), 2), 
        est = round(exp(estimate), 2), 
        effect = paste0(est, " (", ll, " to ", ul, ")", "; p = ", 
                        round(p.value, 2))
      )
    
    return(x$effect[x$term == "groupActive"])
  }
    
    
```


```{r}

# From the paper:
# All randomly assigned patients with data available for the primary endpoints;
# safety analysis included all randomly assigned patients according to the
# treatment received. For the first coprimary endpoint, a risk ratio and 95% CI
# were calculated using binomial regression, and a p value was calculated using
# # a likelihood ratio test...Because some patients died before the end of the
# study, the length of each patientâ€™s period of observation was included as an
# exposure in the model.

  m1_prim_a <- glm(primary_30d ~ group, data = data, 
                   family = binomial(link = "logit")) # OR -Not what
                                                      # they did or reported

  m1_prim_b <- glm(primary_30d ~ group, data = data, 
                   family = binomial(link = "log"), 
                   start = c(-1, 0)) # RR 
  
  m1_prim_c <- logbin(primary_30d ~ group, data = data) # RR - Works - Matches
  m1_prim_d <- logbin(primary_30d ~ 1, data = data) # for the LRT

# Note - this matches but with no adjustment for time under observation.   
  
# pull_ci(m1_prim_b) # Same 
# pull_ci(m1_prim_c)
  
# LRT p-values  
# 1-pchisq(anova(m1_prim_d, m1_prim_c)$Deviance[2], 1)
# 
# drop1(m1_prim_b, test = "Chisq")

```

Using a binomial GLM with a log link function, the estimated effect (relative risk) on the first primary outcome was `r  pull_ci(m1_prim_b)`. This matched what was reported in the paper. 

## Model-based estimate for the second primary outcome (IRR)

```{r}

  data <- mutate(data, log_obs_time = log(obs_time))

  m2_prim_a <- glm.nb(BT_30d_num ~ group, data = data) 
  m2_prim_b <- glm.nb(BT_30d_num ~ group + offset(log(obs_time)), data = data) 
  m2_prim_b <- glm.nb(BT_30d_num ~ group + offset(log_obs_time), data = data) 

```

Using a negative-binomial GLM with a log link function, the estimated effect (incidence rate ratio) on the second primary outcome was `r  pull_ci(m2_prim_b)`. This does not exactly match what was reported in the paper. However, while I have tried to adjust for time under observation, which is what was described in the paper, it is not clear how that was calculated exactly in the original analysis and the apparent variable "offset_30d" is not in my dataset.


# Table 3 (Original subgroups)

## First co-primary

```{r}

  pull_tab <- function(tab_1, col_, arm){ 
    paste0(
      tab_1["Yes", col_, arm], 
      "/", 
      sum(tab_1[, col_, arm]), 
      " (",
      round(tab_1["Yes", col_, arm] / sum(tab_1[, col_, arm]), 2) * 100,
      "%)"
    )
  }

  sub_sum_1 <- function(var, out, ...){
    
    if(length(levels(data[[var]])) == 2){
    
      # Get the basic table of outcomes by arm by subgroup
      tab_1 <- table(data[[out]], data[[var]], data[["group"]]) 
      
      # Model based estimate in subgroup 1
      form_1 <- as.formula(paste0(out, " ~ ", "group"))
      dta <- data[data[[var]] == levels(data[[var]])[1], ]
      m1 <- glm(form_1, data = dta, family = binomial(link = "log"), 
                start = c(-1, 0))
      
      # Model based estimate in subgroup 2
      dta <- data[data[[var]] == levels(data[[var]])[2], ]
      m2 <- glm(form_1, data = dta, family = binomial(link = "log"), 
                start = c(-1, 0))
      
      # LRT p-value for the interaction test
      form_2 <- as.formula(
        paste0(out, " ~ ", "group + ", var, " + ", "group * ", var)
        )
      m3 <- glm(form_2, data = data, family = binomial(link = "log"), 
                start = c(-1, 0, 0, 0))
      pv <- drop1(m3, test = "LRT")[paste0("group:", var), "Pr(>Chi)"]
      
      # Put everything into a dataframe
      out <- data_frame(
        names  = paste(var, levels(data[[var]])), 
        placebo = c(pull_tab(tab_1, 1, "Placebo"), 
                    pull_tab(tab_1, 2, "Placebo")), 
        active  = c(pull_tab(tab_1, 1, "Active"),  
                    pull_tab(tab_1, 2, "Active")), 
        effect = c(pull_ci(m1), pull_ci(m2)), 
        p = round(pv, 2)
      )
    }
    
    if(length(levels(data[[var]])) == 3){
    
      # Get the basic table of outcomes by arm by subgroup
      tab_1 <- table(data[[out]], data[[var]], data[["group"]]) 
      
      # Model based estimate in subgroup 1
      form_1 <- as.formula(paste0(out, " ~ ", "group"))
      dta <- data[data[[var]] == levels(data[[var]])[1], ]
      m1 <- glm(form_1, data = dta, family = binomial(link = "log"), 
                start = c(-1, 0))
      
      # Model based estimate in subgroup 2
      dta <- data[data[[var]] == levels(data[[var]])[2], ]
      m2 <- glm(form_1, data = dta, family = binomial(link = "log"), 
                start = c(-1, 0))
      
      # Model based estimate in subgroup 3
      dta <- data[data[[var]] == levels(data[[var]])[3], ]
      m3 <- glm(form_1, data = dta, family = binomial(link = "log"), 
                start = c(-1, 0))
      
      # LRT p-value for the interaction test
      form_2 <- as.formula(
        paste0(out, " ~ ", "group + ", var, " + ", "group * ", var)
        )
      m4 <- glm(form_2, data = data, family = binomial(link = "log"), 
                start = c(-1, 0, 0, 0, 0, 0))
      pv <- drop1(m4, test = "LRT")[paste0("group:", var), "Pr(>Chi)"]
      
      # Put everything into a dataframe
      out <- data_frame(
        names  = paste(var, levels(data[[var]])), 
        placebo = c(pull_tab(tab_1, 1, "Placebo"), 
                    pull_tab(tab_1, 2, "Placebo"), 
                    pull_tab(tab_1, 3, "Placebo")),
        active  = c(pull_tab(tab_1, 1, "Active"),  
                    pull_tab(tab_1, 2, "Active"), 
                    pull_tab(tab_1, 3, "Active")), 
        effect = c(pull_ci(m1), pull_ci(m2), pull_ci(m3)),
        p = round(pv, 2)
      )
    }
    
    return(out)
    
  }
  
```

```{r}


  vars <- c("age_cat", "tdl_hb_bl_cat", "gender", "bmi_cat",
            "tdl_ferritin_bl_cat", "tdl_tsat_bl_cat")

  map2_dfr(vars, rep("primary_30d", times = length(vars)), sub_sum_1) %>% 
    flextable() %>% autofit()


```

This matches the paper exactly. 

## Second co-primary

```{r}

  pull_means <- function(col_, arm, var){ 
    tar <- data$group == arm & data[[var]] == levels(data[[var]])[col_]
    summary.1(data[tar, ]["BT_30d_num"])
  }

  sub_sum_2 <- function(var, out, ...){
    
    if(length(levels(data[[var]])) == 2){
    
    # Model based estimate in subgroup 1
    form_1 <- as.formula(paste0(out, " ~ ", "group"))
    dta <- data[data[[var]] == levels(data[[var]])[1], ]
    m1 <- glm.nb(form_1, data = dta)
    
    # Model based estimate in subgroup 2
    dta <- data[data[[var]] == levels(data[[var]])[2], ]
    m2 <- glm.nb(form_1, data = dta)
    
    # LRT p-value for the interaction test
    form_2 <- as.formula(
      paste0(out, " ~ ", "group + ", var, " + ", "group * ", var)
      )
    m3 <- glm.nb(form_2, data = data)
    pv <- drop1(m3, test = "LRT")[paste0("group:", var), "Pr(>Chi)"]
    
    # Put everything into a dataframe
    out <- data_frame(
      names  = paste(var, levels(data[[var]])), 
      placebo = c(pull_means(1, "Placebo", var), pull_means(2, "Placebo", var)), 
      active  = c(pull_means(1, "Active",  var), pull_means(2, "Active",  var)), 
      effect = c(pull_ci(m1), pull_ci(m2)), 
      p = round(pv, 2)
    )
    
    }
    
    if(length(levels(data[[var]])) == 3){
    
    # Model based estimate in subgroup 1
    form_1 <- as.formula(paste0(out, " ~ ", "group"))
    dta <- data[data[[var]] == levels(data[[var]])[1], ]
    m1 <- glm.nb(form_1, data = dta)
    
    # Model based estimate in subgroup 2
    dta <- data[data[[var]] == levels(data[[var]])[2], ]
    m2 <- glm.nb(form_1, data = dta)
    
    # Model based estimate in subgroup 2
    dta <- data[data[[var]] == levels(data[[var]])[3], ]
    m3 <- glm.nb(form_1, data = dta)
    
    # LRT p-value for the interaction test
    form_2 <- as.formula(
      paste0(out, " ~ ", "group + ", var, " + ", "group * ", var)
      )
    m4 <- glm.nb(form_2, data = data)
    pv <- drop1(m4, test = "LRT")[paste0("group:", var), "Pr(>Chi)"]
    
    # Put everything into a dataframe
    out <- data_frame(
      names  = paste(var, levels(data[[var]])), 
      placebo = c(pull_means(1, "Placebo", var), 
                  pull_means(2, "Placebo", var), 
                  pull_means(3, "Placebo", var)), 
      active  = c(pull_means(1, "Active",  var), 
                  pull_means(2, "Active",  var), 
                  pull_means(3, "Active",  var)), 
      effect = c(pull_ci(m1), pull_ci(m2), pull_ci(m3)), 
      p = round(pv, 2)
    )
    
    }
    
    return(out)
    
  }
  
  
  
```

```{r}


  vars <- c("age_cat", "tdl_hb_bl_cat", "gender", "bmi_cat",
            "tdl_ferritin_bl_cat", "tdl_tsat_bl_cat")

  map2_dfr(vars, rep("BT_30d_num", times = length(vars)), sub_sum_2) %>% 
    flextable() %>% autofit()
  


```

Means and SDs all match exactly, but the models, just like for the main models, do not match exactly. 


# Additional subgroup analyses

## First primary (RR)

```{r}


  vars <- c("tdl_ferritin_bl_cat_2",  "tdl_tsat_bl_cat", "fer_tsat_or",
            "fer_tsat_and")

  map2_dfr(vars, rep("primary_30d", times = length(vars)), sub_sum_1) %>% 
    flextable() %>% autofit()


```

These match almost exactly. The only difference is for the low tsat OR low ferritin subgroup. I don't think they accounted for missing values in their OR statement, whereas I have a missing value for the subgroup flag if you are missing either a tsat or ferritin value. 

## Second primary (IRR)

```{r}


  vars <- c("tdl_ferritin_bl_cat_2",  "tdl_tsat_bl_cat", "fer_tsat_or",
            "fer_tsat_and")

  map2_dfr(vars, rep("BT_30d_num", times = length(vars)), sub_sum_2) %>% 
    flextable() %>% autofit()


```


```{r}

# Deaths - Indicator, time of surgery, time of death - names(data)[c(51, 53, 58:59)]

  # table(data$died)
  # data$death_rand_time[data$died == 1]
  # 
  # table(data$death_30d)
  # data$death_rand_time[data$death_30d == "Yes"] # QUERY Not this one
  # data$death_surg_time[data$death_30d == "Yes"] # Yes this one
  # 
  # table(is.na(data$death_time[data$died == 0]))


```

```{r}

# 30 day outcomes - names(data)[c(66:70, 81)]
  
# 8 week outcomes - names(data)[c(71:75)]
  
# 6 month outcomes - names(data[c(76:80, 82, 83)])

```


```{r if_html, eval = knitr::opts_knit$get("rmarkdown.pandoc.to") == "html"}

# use flextable (works for MD files on github too)

```

```{r if_word, eval = !knitr::opts_knit$get("rmarkdown.pandoc.to") == "html"}

# use kable

```

```{r code_book}

  print(summarytools::dfSummary(data), method = "render")

```

```{r sysinfo}

  DescTools::SysInfo()

```




```{r}

  ggplot(data, aes(surg_plan_dt, surg_dt)) +
    geom_point(size = 3, alpha = 0.3)
 
```


Difference between baseline TBL and site hb values. 

```{r}

  ggplot(data, aes(tdl_hb_bl, site_hb_bl, color = group)) + geom_point()

```
