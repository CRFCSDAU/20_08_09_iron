---
title: ''
author: ''
date: ''
output: 
  html_document:
    df_print: paged
    keep_md: true
  word_document:
    reference_docx: style.1.docx
---

```{r setup, include = FALSE}

  knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                        fig.width  = 6 * 1.67, fig.height = 6)

  proj <- rprojroot::find_rstudio_root_file()
  knitr::opts_knit$set(root.dir = proj)
  
  load(paste0(proj, "/data/data.RData"))
  
  source(paste0(proj, "/scripts/functions.R"))

  # load("data/data.RData")
  # 
  # source("scripts/functions.R")
  
  library(logbin)
  library(MASS)
  library(descr)
  library(tidyverse)
  library(viridis)
  library(knitr)
  library(rms)
  library(Hmisc)
  library(patchwork)
  
  dd <- datadist(data); options(datadist = "dd")

```

```{r}

# Pull confidence intervals for the treatment effect from a model (with and
# without exponentiation)

  pull_ci <- function(model){
    
    library(broom)
    x <- tidy(model) %>%
      mutate(
        ul = round(exp(estimate + (1.96 * std.error)), 2), 
        ll = round(exp(estimate - (1.96 * std.error)), 2), 
        est = round(exp(estimate), 2), 
        effect = paste0(est, " (", ll, " to ", ul, ")", "; p = ", 
                        round(p.value, 2))
      )
    
    return(x$effect[x$term == "groupActive"])
  }

  pull_ci_2 <- function(model){
    
    library(broom)
    x <- tidy(model) %>%
      mutate(
        ul = round(estimate + (1.96 * std.error), 2), 
        ll = round(estimate - (1.96 * std.error), 2), 
        est = round(estimate, 2), 
        effect = paste0(est, " (", ll, " to ", ul, ")", "; p = ", 
                        round(p.value, 2))
      )
    
    return(x$effect[x$term == "groupActive"])
  }
    
    
```


# HTE by baseline lab values 

## Binary outcomes

HTE was estimated using logistic regression models with an interaction between treatment arms and a given baseline lab value (one for each model). Lab values were modeled with restricted cubic splines with 4 knots, and each model is adjusted for age. 

Alternately, HTE was estimated using the same categorized versions of baseline ferritin, TSAT and their combinations (either low and both low), following what was previously done using log binomial models (**Original models**). 

### First co-primary outcome

#### Original models

```{r}

# Pulls the key summary info our of a given table

  pull_tab <- function(tab_1, col_, arm, out){ 
    paste0(
      tab_1[levels(data[[out]])[2], col_, arm], 
      "/", 
      sum(tab_1[, col_, arm]), 
      " (",
      round(
        tab_1[levels(data[[out]])[2], col_, arm] / sum(tab_1[, col_, arm]), 2
        ) * 100,
      "%)"
    )
  }

# Subgroup specific estimates and test of the overall interaction, log binomial
# models

  sub_sum_1 <- function(var, out, ...){
    
    if(length(levels(data[[var]])) == 2){
    
      # Get the basic table of outcomes by arm by subgroup
      tab_1 <- table(data[[out]], data[[var]], data[["group"]]) 
      
      # Model based estimate in subgroup 1
      form_1 <- as.formula(paste0(out, " ~ ", "group"))
      dta <- data[data[[var]] == levels(data[[var]])[1], ]
      m1 <- glm(form_1, data = dta, family = binomial(link = "log"), 
                start = c(-1, 0))
      
      # Model based estimate in subgroup 2
      dta <- data[data[[var]] == levels(data[[var]])[2], ]
      m2 <- glm(form_1, data = dta, family = binomial(link = "log"), 
                start = c(-1, 0))
      
      # LRT p-value for the interaction test
      form_2 <- as.formula(
        paste0(out, " ~ ", "group + ", var, " + ", "group * ", var)
        )
      m3 <- glm(form_2, data = data, family = binomial(link = "log"), 
                start = c(-1, 0, 0, 0))
      pv <- drop1(m3, test = "LRT")[paste0("group:", var), "Pr(>Chi)"]
      
      # Put everything into a dataframe
      out <- data_frame(
        names  = paste(var, levels(data[[var]])), 
        placebo = c(pull_tab(tab_1, 1, "Placebo", out), 
                    pull_tab(tab_1, 2, "Placebo", out)), 
        active  = c(pull_tab(tab_1, 1, "Active", out),  
                    pull_tab(tab_1, 2, "Active", out)), 
        effect = c(pull_ci(m1), pull_ci(m2)), 
        p = round(pv, 2)
      )
    }
    
    if(length(levels(data[[var]])) == 3){
    
      # Get the basic table of outcomes by arm by subgroup
      tab_1 <- table(data[[out]], data[[var]], data[["group"]]) 
      
      # Model based estimate in subgroup 1
      form_1 <- as.formula(paste0(out, " ~ ", "group"))
      dta <- data[data[[var]] == levels(data[[var]])[1], ]
      m1 <- glm(form_1, data = dta, family = binomial(link = "log"), 
                start = c(-1, 0))
      
      # Model based estimate in subgroup 2
      dta <- data[data[[var]] == levels(data[[var]])[2], ]
      m2 <- glm(form_1, data = dta, family = binomial(link = "log"), 
                start = c(-1, 0))
      
      # Model based estimate in subgroup 3
      dta <- data[data[[var]] == levels(data[[var]])[3], ]
      m3 <- glm(form_1, data = dta, family = binomial(link = "log"), 
                start = c(-1, 0))
      
      # LRT p-value for the interaction test
      form_2 <- as.formula(
        paste0(out, " ~ ", "group + ", var, " + ", "group * ", var)
        )
      m4 <- glm(form_2, data = data, family = binomial(link = "log"), 
                start = c(-1, 0, 0, 0, 0, 0))
      pv <- drop1(m4, test = "LRT")[paste0("group:", var), "Pr(>Chi)"]
      
      # Put everything into a dataframe
      out <- data_frame(
        names  = paste(var, levels(data[[var]])), 
        placebo = c(pull_tab(tab_1, 1, "Placebo", out), 
                    pull_tab(tab_1, 2, "Placebo", out), 
                    pull_tab(tab_1, 3, "Placebo", out)),
        active  = c(pull_tab(tab_1, 1, "Active", out),  
                    pull_tab(tab_1, 2, "Active", out), 
                    pull_tab(tab_1, 3, "Active", out)), 
        effect = c(pull_ci(m1), pull_ci(m2), pull_ci(m3)),
        p = round(pv, 2)
      )
    }
    
    return(out)
    
  }
  
```


```{r}

  int_vars <- c("tdl_ferritin_bl_cat_2",  "tdl_tsat_bl_cat", "fer_tsat_or",
            "fer_tsat_and")

  map2_dfr(int_vars, rep("primary_30d", times = length(vars)), sub_sum_1) %>% 
    kable()


```

These match almost exactly. The only difference is for the low tsat OR low ferritin subgroup. In the original analysis it looks like there are 5 individuals with a missing TSAT and a ferritin > 100 but that were counted as *low TSAT OR low ferritin*. 

#### New models

```{r}

  inverse_logit <- function(x){
    1 / (1 + exp(-x))
  }


# Estimate logistic regression model taking a lab variable as a predictor
  lrm_ <- function(out, var){
    form_ <- as.formula(paste0(
      out, " ~ group * rcs(", var,", 4) + rcs(age, 4)"
    )) 
    m1 <- lrm(form_, data = data)
    return(m1)
  }

```

```{r}

# The various lab variables we want to consider

  baseline_labs <- c(
    "tdl_hb_bl", "tdl_ferritin_bl", "tdl_tsat_bl", "tdl_iron_bl", "tdl_tibc_bl"
    )
    
  baseline_labs_log <- c(
    "log_tdl_hb_bl", "log_tdl_ferritin_bl", "log_tdl_tsat_bl",
    "log_tdl_iron_bl", "log_tdl_tibc_bl"
    )
    
```

```{r}

  models <- map(baseline_labs, lrm_, out = "primary_30d")

```

Predicted outcomes from logistic regression models of the primary outcome with an interaction between treatment arm and a given baseline lab value (modeled continuously with splines). 

```{r}

  plot_int_lrm <- function(model, var, lims){
     fac <- setNames(list(NA, NA), c(var, "group"))
     ggplot(Predict(model, var, group, factors = fac)) +
       coord_cartesian(ylim = lims) +
       guides(color = FALSE) 
  }

```

```{r}

  plots <- map2(models, baseline_labs, plot_int_lrm, lims = c(-5, 2))

  plots[[1]] + plots[[2]] + plots[[3]] + guides(color = guide_legend("")) +
    plots[[4]] + plots[[5]] 

```

Tests of the interactions

```{r}

  test_int <- function(var, mod){
    
    var <- label(data[[var]]) 
    t1 <- anova(mod)[2, ] %>%
      t() %>%
      as.data.frame() %>%
      mutate(lab_variable = var) %>%
      select(lab_variable, P, everything()) 
    
    t1[map_lgl(t1, is.numeric)] <- map( t1[map_lgl(t1, is.numeric)], round, 2)
    
    return(t1)
  }

```

```{r}

  map2_dfr(baseline_labs, models, test_int) %>% kable()

```

Now with logged values. 

```{r}

  models <- map(baseline_labs_log, lrm_, out = "primary_30d")

```

```{r}

  plots <- map2(models, baseline_labs_log, plot_int_lrm, lims = c(-3, 2))

  plots[[1]] + plots[[2]] + plots[[3]] + guides(color = guide_legend("")) +
    plots[[4]] + plots[[5]] 

```

```{r}

  map2_dfr(baseline_labs, models, test_int) %>% kable()

```

### CD grade III or above to discharge

#### Original models

```{r}

  map2_dfr(int_vars, rep("post_op_comp3", times = length(vars)), sub_sum_1) %>% 
    kable()

```

#### New models

Predicted outcomes from logistic regression models of the outcome with an interaction between treatment arm and a given baseline lab value (modeled continuously with splines). 

```{r}

  models <- map(baseline_labs, lrm_, out = "post_op_comp3")

  plots <- map2(models, baseline_labs, plot_int_lrm, lims = c(-10, 0.5))

  plots[[1]] + plots[[2]] + plots[[3]] + guides(color = guide_legend("")) +
    plots[[4]] + plots[[5]] 


```

```{r}

  map2_dfr(baseline_labs, models, test_int) %>% kable()

```

Now with logged values. 

```{r}

  models <- map(baseline_labs_log, lrm_, out = "post_op_comp3")

  plots <- map2(models, baseline_labs_log, plot_int_lrm, lims = c(-10, 0.5))

  plots[[1]] + plots[[2]] + plots[[3]] + guides(color = guide_legend("")) +
    plots[[4]] + plots[[5]] 


```


```{r}

  map2_dfr(baseline_labs_log, models, test_int) %>% kable()

```

### All cause mortality at 6 months

#### Original models 

```{r}

  map2_dfr(int_vars, rep("death_6mo", times = length(vars)), sub_sum_1) %>% 
    kable()

```

#### New models

Predicted outcomes from logistic regression models of the outcome with an interaction between treatment arm and a given baseline lab value (modeled continuously with splines). 

```{r}

  models <- map(baseline_labs, lrm_, out = "death_6mo")

  plots <- map2(models, baseline_labs, plot_int_lrm, lims = c(-10, 0.5))

  plots[[1]] + plots[[2]] + plots[[3]] + guides(color = guide_legend("")) +
    plots[[4]] + plots[[5]] 


```


```{r}

  map2_dfr(baseline_labs, models, test_int) %>% kable()

```

Logged values

```{r}

  models <- map(baseline_labs_log, lrm_, out = "death_6mo")

  plots <- map2(models, baseline_labs_log, plot_int_lrm, lims = c(-10, 0.5))

  plots[[1]] + plots[[2]] + plots[[3]] + guides(color = guide_legend("")) +
    plots[[4]] + plots[[5]] 


```

```{r}

  map2_dfr(baseline_labs_log, models, test_int) %>% kable()

```


### Any readmission for complications - Discharge to 8 weeks

#### Original models

```{r}

  map2_dfr(int_vars, rep("comp8wk", times = length(vars)), sub_sum_1) %>% 
    kable()

```

#### New models

Predicted outcomes from logistic regression models of the outcome with an interaction between treatment arm and a given baseline lab value (modeled continuously with splines).

```{r}

  models <- map(baseline_labs, lrm_, out = "comp8wk")

  plots <- map2(models, baseline_labs, plot_int_lrm, lims = c(-5, 0.5))

  plots[[1]] + plots[[2]] + plots[[3]] + guides(color = guide_legend("")) +
    plots[[4]] + plots[[5]] 


```


```{r}

  map2_dfr(baseline_labs, models, test_int) %>% kable()

```

Logged values

```{r}

  models <- map(baseline_labs_log, lrm_, out = "comp8wk")

  plots <- map2(models, baseline_labs_log, plot_int_lrm, lims = c(-5, 0.5))

  plots[[1]] + plots[[2]] + plots[[3]] + guides(color = guide_legend("")) +
    plots[[4]] + plots[[5]] 


```

```{r}

  map2_dfr(baseline_labs_log, models, test_int) %>% kable()

```


### Any readmission for complications - Discharge to 6 months

#### Orignal models

```{r}

  map2_dfr(int_vars, rep("comp6m", times = length(vars)), sub_sum_1) %>% 
    kable()

```

#### New models

Predicted outcomes from logistic regression models of the outcome with an interaction between treatment arm and a given baseline lab value (modeled continuously with splines).

```{r}

  models <- map(baseline_labs, lrm_, out = "comp6m")

  plots <- map2(models, baseline_labs, plot_int_lrm, lims = c(-2.5, 0.5))

  plots[[1]] + plots[[2]] + plots[[3]] + guides(color = guide_legend("")) +
    plots[[4]] + plots[[5]] 


```


```{r}

  map2_dfr(baseline_labs, models, test_int) %>% kable()

```

Logged values

```{r}

  models <- map(baseline_labs_log, lrm_, out = "comp6m")

  plots <- map2(models, baseline_labs_log, plot_int_lrm, lims = c(-2.5, 0.5))

  plots[[1]] + plots[[2]] + plots[[3]] + guides(color = guide_legend("")) +
    plots[[4]] + plots[[5]] 


```

```{r}

  map2_dfr(baseline_labs_log, models, test_int) %>% kable()

```

## Count outcomes

HTE was estimated using quasi-poisson models with an interaction between treatment arms and a given baseline lab value (one for each model). Lab values were modeled with restricted cubic splines with 4 knots, and each model is adjusted for age and an offset for time at risk when relevant.

Alternately, HTE was estimated using the same categorized versions of baseline ferritin, TSAT and their combinations (either low and both low), following what was previously done with negative binomial models (**Original models**). 

### Second primary outcome - Number of tranfusions at 30 days

#### Original models

```{r}

  pull_means <- function(col_, arm, var){ 
    tar <- data$group == arm & data[[var]] == levels(data[[var]])[col_]
    summary.1(data[tar, ]["BT_30d_num"])
  }

  sub_sum_2 <- function(var, out, offset, ...){
    
    if(length(levels(data[[var]])) == 2){
    
    # Model based estimate in subgroup 1
      if(!is.null(offset)){
        form_1 <- as.formula(
          paste0(out, " ~ ", "group + offset(log(", offset, "))")
          )
      }else{
        form_1 <- as.formula(paste0(out, " ~ ", "group"))
      }
    dta <- data[data[[var]] == levels(data[[var]])[1], ]
    m1 <- glm.nb(form_1, data = dta)
    
    # Model based estimate in subgroup 2
    dta <- data[data[[var]] == levels(data[[var]])[2], ]
    m2 <- glm.nb(form_1, data = dta)
    
    # LRT p-value for the interaction test
    if(!is.null(offset)){
        form_2 <- as.formula(
          paste0(out, " ~ ", "group + ", var, " + ", "group * ", var, 
             " + offset(log(", offset, "))")
          )
      }else{
        form_2 <- as.formula(
          paste0(out, " ~ ", "group + ", var, " + ", "group * ", var)
          )
      }
    
    m3 <- glm.nb(form_2, data = data)
    pv <- drop1(m3, test = "LRT")[paste0("group:", var), "Pr(>Chi)"]
    
    # Put everything into a dataframe
    out <- data_frame(
      names  = paste(var, levels(data[[var]])), 
      placebo = c(pull_means(1, "Placebo", var), pull_means(2, "Placebo", var)), 
      active  = c(pull_means(1, "Active",  var), pull_means(2, "Active",  var)), 
      effect = c(pull_ci(m1), pull_ci(m2)), 
      p = round(pv, 2)
    )
    
    }
    
    if(length(levels(data[[var]])) == 3){
    
    # Model based estimate in subgroup 1
    if(is.null(offset)){
        form_1 <- as.formula(
          paste0(out, " ~ ", "group + offset(log(", offset, "))")
          )
      }else{
        form_1 <- as.formula(paste0(out, " ~ ", "group"))
      }
    dta <- data[data[[var]] == levels(data[[var]])[1], ]
    m1 <- glm.nb(form_1, data = dta)
    
    # Model based estimate in subgroup 2
    dta <- data[data[[var]] == levels(data[[var]])[2], ]
    m2 <- glm.nb(form_1, data = dta)
    
    # Model based estimate in subgroup 2
    dta <- data[data[[var]] == levels(data[[var]])[3], ]
    m3 <- glm.nb(form_1, data = dta)
    
    # LRT p-value for the interaction test
    if(!is.null(offset)){
        form_2 <- as.formula(
          paste0(out, " ~ ", "group + ", var, " + ", "group * ", var, 
             " + offset(log(", offset, "))")
          )
      }else{
        form_2 <- as.formula(
          paste0(out, " ~ ", "group + ", var, " + ", "group * ", var)
          )
      }
    m4 <- glm.nb(form_2, data = data)
    pv <- drop1(m4, test = "LRT")[paste0("group:", var), "Pr(>Chi)"]
    
    # Put everything into a dataframe
    out <- data_frame(
      names  = paste(var, levels(data[[var]])), 
      placebo = c(pull_means(1, "Placebo", var), 
                  pull_means(2, "Placebo", var), 
                  pull_means(3, "Placebo", var)), 
      active  = c(pull_means(1, "Active",  var), 
                  pull_means(2, "Active",  var), 
                  pull_means(3, "Active",  var)), 
      effect = c(pull_ci(m1), pull_ci(m2), pull_ci(m3)), 
      p = round(pv, 2)
    )
    
    }
    
    return(out)
    
  }
  
```

```{r}

  map2_dfr(int_vars, rep("BT_30d_num", times = length(vars)), sub_sum_2, 
           offset = "obs_time_1") %>% 
    kable()

```
 (30 day mortality offset makes this match original result)


#### New models

Predicted outcomes from quasi-Poison regression models of the outcome with an interaction between treatment arm and a given baseline lab value (modeled continuously with splines).

```{r}

# With offset
  quasip_1 <- function(out, var, offset){
    form_ <- as.formula(paste0(
      out, " ~ group * rcs(", var, ", 4) + rcs(age, 4) + offset(", 
      offset, ")"
    )) 
    m1 <- Glm(form_, family = quasipoisson(), data = data)
    return(m1)
  }

# No offset
  quasip_2 <- function(out, var){
    form_ <- as.formula(paste0(
      out, " ~ group * rcs(", var, ", 4) + rcs(age, 4)"
    )) 
    m1 <- Glm(form_, family = quasipoisson(), data = data)
    return(m1)
  }

  plot_int_qp <- function(model, var, lims){
     fac <- setNames(list(NA, NA), c(var, "group"))
     off <- setNames(list(NA), c("obs_time_1_log"))
     ggplot(Predict(model, var, group, factors = fac, offset = off)) +
       coord_cartesian(ylim = lims) +
       guides(color = FALSE) 
  }

```


```{r}

  models <- map(baseline_labs, quasip_1, out = "BT_30d_num", 
                offset = "obs_time_1_log")

  plots <- map2(models, baseline_labs, plot_int_qp, lims = c(-10, -2))

  plots[[1]] + plots[[2]] + plots[[3]] + guides(color = guide_legend("")) +
    plots[[4]] + plots[[5]] 


```

```{r}

  map2_dfr(baseline_labs, models, test_int) %>% kable()

```

Logged values

```{r}

  models <- map(baseline_labs_log, quasip_1, out = "BT_30d_num", 
                offset = "obs_time_1_log")

  plots <- map2(models, baseline_labs_log, plot_int_qp, lims = c(-8, -2))

  plots[[1]] + plots[[2]] + plots[[3]] + guides(color = guide_legend("")) +
    plots[[4]] + plots[[5]] 

```

```{r}

  map2_dfr(baseline_labs_log, models, test_int) %>% kable()

```

### Units of blood to 30 days (excluding LBT)

#### Original models

```{r}

  map2_dfr(int_vars, rep("UNITS_30d_num", times = length(vars)), sub_sum_2, 
           offset = "obs_time_1") %>% 
    kable()

```

#### New models

Predicted outcomes from logistic regression models of the outcome with an interaction between treatment arm and a given baseline lab value (modeled continuously with splines).

```{r}

  models <- map(baseline_labs, quasip_1, out = "UNITS_30d_num", 
                offset = "obs_time_1_log")

  plots <- map2(models, baseline_labs, plot_int_qp, lims = c(-6, -3))

  plots[[1]] + plots[[2]] + plots[[3]] + guides(color = guide_legend("")) +
    plots[[4]] + plots[[5]] 


```

```{r}

  map2_dfr(baseline_labs, models, test_int) %>% kable()

```

Logged values

```{r}

  models <- map(baseline_labs_log, quasip_1, out = "UNITS_30d_num", 
                offset = "obs_time_1_log")

  plots <- map2(models, baseline_labs_log, plot_int_qp, lims = c(-6, -3))

  plots[[1]] + plots[[2]] + plots[[3]] + guides(color = guide_legend("")) +
    plots[[4]] + plots[[5]] 

```

```{r}

  map2_dfr(baseline_labs_log, models, test_int) %>% kable()

```


### Units of blood to 6 months (exluding LBT)

#### Original models

```{r}

  map2_dfr(int_vars, rep("UNITS_6mo_num", times = length(vars)), sub_sum_2, 
           offset = "obs_time_2") %>% 
    kable()

```

#### New models

Predicted outcomes from logistic regression models of the outcome with an interaction between treatment arm and a given baseline lab value (modeled continuously with splines).

```{r}

  models <- map(baseline_labs, quasip_1, out = "UNITS_6mo_num", 
                offset = "obs_time_1_log")

  plots <- map2(models, baseline_labs, plot_int_qp, lims = c(-6, -2))

  plots[[1]] + plots[[2]] + plots[[3]] + guides(color = guide_legend("")) +
    plots[[4]] + plots[[5]] 

```

```{r}

  map2_dfr(baseline_labs, models, test_int) %>% kable()

```

Logged values

```{r}

  models <- map(baseline_labs_log, quasip_2, out = "UNITS_6mo_num")

  plots <- map2(models, baseline_labs_log, plot_int_qp, lims = c(-2, 2))

  plots[[1]] + plots[[2]] + plots[[3]] + guides(color = guide_legend("")) +
    plots[[4]] + plots[[5]] 

```

```{r}

  map2_dfr(baseline_labs_log, models, test_int) %>% kable()

```


# End matter

```{r sysinfo}

  DescTools::SysInfo()

```
